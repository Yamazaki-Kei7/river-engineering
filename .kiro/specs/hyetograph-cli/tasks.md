# Implementation Plan

## VBA検証用テストデータ

以下のパラメータでVBA出力と一致することを検証する:
- A=0.75, B=5.411, C=1557.825, T=10[分], TT=2[時間], NT=12

| I | 増分雨量 R(I) |
|---|--------------|
| 1 | 141.179 |
| 2 | 68.369 |
| 3 | 46.819 |
| 4 | 35.957 |
| 5 | 29.354 |
| 6 | 24.900 |
| 7 | 21.684 |
| 8 | 19.249 |
| 9 | 17.339 |
| 10 | 15.799 |
| 11 | 14.530 |
| 12 | 13.465 |

**前方集中型**: [141.179, 68.369, 46.819, 35.957, 29.354, 24.900, 21.684, 19.249, 17.339, 15.799, 14.530, 13.465]
**中央集中型**: [13.465, 15.799, 19.249, 24.900, 35.957, 68.369, 141.179, 46.819, 29.354, 21.684, 17.339, 14.530]
**後方集中型**: [13.465, 14.530, 15.799, 17.339, 19.249, 21.684, 24.900, 29.354, 35.957, 46.819, 68.369, 141.179]

## Tasks

- [x] 1. プロジェクト初期化と共有型定義
- [x] 1.1 Rustプロジェクトの作成と依存関係の設定
  - `cargo init`でバイナリプロジェクトを作成する
  - Cargo.tomlに依存クレートを追加する: clap（derive feature）、plotters、csv、serde（derive feature）、anyhow
  - プロジェクトがビルドできることを確認する
  - _Requirements: 5.4, 5.5_

- [x] 1.2 (P) 共有データ型の定義
  - 降雨強度計算のパラメータを保持する型を定義する（A, B, C, T, TT）
  - ハイエトグラフの1エントリを表す型を定義する（経過時間と降雨強度のペア）。CSVのSerializeを導出する
  - 雨量分布パターンの列挙型を定義する（前方集中、中央集中、後方集中）。clapのValueEnumとして利用可能にする
  - 出力形式の列挙型を定義する（PNG、CSV、両方）。clapのValueEnumとして利用可能にする
  - _Requirements: 2.4, 5.2, 5.3_

- [x] 2. 降雨強度計算の実装
- [x] 2.1 (P) RKEISAN相当の増分雨量計算ロジック
  - 時間ステップ数 NT = TT * 60 / T を算出する
  - 各ステップI（1〜NT）について降雨強度 K = C / ((T * I)^A + B) を計算する
  - 増分雨量 R(I) = K * I - ZK（ZKは前ステップの累計値 K * I）を算出する
  - VBAと同一の演算順序を維持し、f64精度での一致を保証する
  - テストデータ（A=0.75, B=5.411, C=1557.825, T=10, TT=2）でVBA出力との数値一致を検証するユニットテストを作成する。期待値: R(1)≈141.179, R(2)≈68.369, ..., R(12)≈13.465
  - 増分雨量の総和保存のテストを作成する
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 3. 雨量分布配置の実装
- [x] 3.1 (P) 3パターンの配置ロジック
  - 前方集中型: 増分雨量を降順のまま時間軸先頭から配置する
  - 中央集中型: 奇数番目の増分雨量を中央から後方へ、偶数番目を中央から前方へ交互に配置する（VBA Case 2と同一ロジック）
  - 後方集中型: 増分雨量を降順の逆（昇順）で時間軸先頭から配置する
  - 経過時間を T * index で算出し、各エントリに設定する
  - 上記テストデータの3パターン期待値で配置結果を検証するユニットテストを作成する
  - 配置前後の雨量総和が一致する保存則のテストを作成する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4. CLI引数解析とバリデーション
- [x] 4.1 (P) clapによるCLI引数定義
  - clap derive macroで引数構造体を定義する: A, B, C, T, TTを必須引数、pattern/output/formatをオプション引数にする
  - patternのデフォルト値を中央集中型、outputのデフォルト値を`hyetograph.png`、formatのデフォルト値をPNGに設定する
  - `--help`で使用方法と使用例が表示されることを確認する
  - `--version`でバージョン情報が表示されることを確認する
  - 必須引数不足時にエラーメッセージとヘルプ参照が表示されることを確認する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

- [x] 4.2 入力バリデーションの実装
  - A, B, C, Tが正値（> 0）であることを検証し、違反時にパラメータ名と有効範囲をエラーメッセージに含める
  - TTが正値であることを検証する
  - TT * 60 / Tが整数になることを検証し、不適切な場合にエラーメッセージを表示する
  - 出力先ファイルの親ディレクトリが存在することを確認する
  - すべてのエラーをstderrに出力する
  - 正常値・異常値の境界値テストを作成する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 5. CSV出力の実装
- [x] 5.1 (P) CSVファイル出力機能
  - csvクレートとSerdeを使用して、ハイエトグラフデータをCSVファイルに書き出す
  - ヘッダー行（経過時間[分]、降雨強度[mm/h]）を含める
  - 出力先パスの親ディレクトリ不在時にコンテキスト付きエラーを返す
  - テストデータを使用した出力内容検証のユニットテストを作成する
  - _Requirements: 4.1, 4.2_

- [x] 6. PNG棒グラフ出力の実装
- [x] 6.1 (P) plottersによるハイエトグラフ描画
  - plottersのBitMapBackendでPNG画像を生成する（デフォルトサイズ: 800x600）
  - ChartBuilderで棒グラフを構成する: 横軸に経過時間、縦軸に降雨強度(mm/h)
  - 各時間ステップをバー（Rectangle要素）として描画する
  - グラフタイトル（"Hyetograph"）と軸ラベル（"Time [min]", "Intensity [mm/h]"）を自動設定する
  - 出力先パスの親ディレクトリ不在時にコンテキスト付きエラーを返す
  - テストデータでPNGファイルが正常に生成されることを確認するテストを作成する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 7. メインパイプラインの統合
- [x] 7.1 全コンポーネントの接続
  - main関数で以下の処理フローを実装する: CLI引数解析 → バリデーション → 降雨強度計算 → 雨量分布配置 → 出力形式に応じた出力
  - 出力形式がPNGの場合はPNG出力、CSVの場合はCSV出力、Bothの場合は両方を実行する
  - 正常完了時に出力ファイルパスをstdoutに表示し、終了コード0で終了する
  - エラー時はstderrにメッセージを出力し、終了コード1で終了する
  - _Requirements: 4.3, 5.7, 6.6_

- [x] 8. VBA互換性テストと統合テスト
- [x] 8.1 VBAテストデータを使用したE2Eテスト
  - A=0.75, B=5.411, C=1557.825, T=10, TT=2のパラメータで前方集中型を実行し、CSV出力がVBA期待値と一致することを検証する
  - 同パラメータで中央集中型を実行し、CSV出力がVBA期待値と一致することを検証する
  - 同パラメータで後方集中型を実行し、CSV出力がVBA期待値と一致することを検証する
  - PNG出力が3パターンとも正常に生成されることを確認する
  - _Requirements: 1.3, 2.1, 2.2, 2.3_

- [x] 8.2 エラーケースの統合テスト
  - 負のパラメータ指定時にエラーメッセージが表示され、終了コードが非0になることを確認する
  - TT*60/Tが非整数になるパラメータでエラーが返ることを確認する
  - 存在しない出力ディレクトリ指定時にエラーが返ることを確認する
  - `--help`と`--version`が正常に動作することを確認する
  - _Requirements: 6.1, 6.2, 6.4, 6.5_
